name: Deploy Theme
on:
  push:
    branches:
      - master
      - main
jobs:
  deploy:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Production Theme
        # This creates dist/m4-ghost-vX.X.zip
        run: npm run production -- --production

      - name: Rename Zip for Deployment
        run: mv dist/*.zip dist/theme.zip

      - name: Copy Theme to Server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "dist/theme.zip"
          target: "/tmp/"

      - name: Install Theme on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # 1. Go to themes directory
            cd /var/www/ghost/content/themes

            # 2. Remove the existing theme folder (Nuclear option to ensure update)
            # Make sure 'm4-ghost' matches your theme folder name exactly!
            sudo rm -rf m4-ghost

            # 3. Unzip the new theme
            sudo unzip -o /tmp/dist/theme.zip -d m4-ghost

            # 4. Cleanup tmp file
            sudo rm -rf /tmp/dist

            # 5. Fix permissions (Crucial)
            sudo chown -R ghost:ghost m4-ghost

            # 6. Restart Ghost
            cd /var/www/ghost
            ghost restart

      - name: Purge Cloudflare Cache
        if: success()
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
          -H "Authorization: Bearer ${{ secrets.CF_PURGE }}" \
          -H "Content-Type: application/json" \
          --data '{"purge_everything":true}'