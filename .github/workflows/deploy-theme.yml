name: Deploy Theme
on:
  push:
    branches:
      - master
      - main
jobs:
  deploy:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Production Theme
        run: npm run production -- --production

      - name: Rename Zip
        run: mv dist/*.zip dist/theme.zip

      - name: Copy Theme to Server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "dist/theme.zip"
          target: "/tmp/"

      - name: Install Theme on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # 1. Stop Ghost to release file locks
            cd /var/www/ghost
            sudo systemctl stop ghost_m44-cl || echo "Ghost not running or name different"

            # 2. Go to themes directory
            cd content/themes

            # 3. Force remove old assets explicitly to ensure update
            sudo rm -rf m4-ghost/assets/scripts/post.js

            # 4. Unzip the new theme OVER existing folder
            sudo unzip -o /tmp/dist/theme.zip -d m4-ghost

            # 5. Cleanup tmp file
            sudo rm -rf /tmp/dist

            # 6. Fix permissions
            sudo chown -R ghost:ghost m4-ghost

            # 7. Start Ghost
            cd /var/www/ghost
            sudo systemctl start ghost_m44-cl
            
            # 8. Force restart just in case
            ghost restart

      - name: Purge Cloudflare Cache
        if: success()
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
          -H "Authorization: Bearer ${{ secrets.CF_PURGE }}" \
          -H "Content-Type: application/json" \
          --data '{"purge_everything":true}'