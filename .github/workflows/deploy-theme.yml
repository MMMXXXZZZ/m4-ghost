name: Deploy Theme
on:
  push:
    branches:
      - master
      - main
jobs:
  deploy:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Production Theme
        run: npm run prod

      - name: Rename Zip
        run: mv dist/*.zip dist/m4.zip

      - name: Copy Theme to Server via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "dist/m4.zip"
          target: "/tmp/"

      - name: Install Theme on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd /var/www/ghost
            sudo systemctl stop ghost_m44-cl || true
            
            cd content/themes
            sudo rm -rf m4-ghost
            sudo unzip -o /tmp/dist/m4.zip -d m4-ghost
            
            echo ">>> VERIFYING post.hbs ON SERVER <<<"
            grep -C 5 "js-infinite-container" m4-ghost/post.hbs || echo "CLASS NOT FOUND IN FILE"
            
            sudo rm -rf /tmp/dist
            sudo chown -R ghost:ghost m4-ghost
            
            cd /var/www/ghost
            sudo systemctl start ghost_m44-cl || true
            ghost restart

      - name: Purge Cloudflare Cache
        if: success()
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
          -H "Authorization: Bearer ${{ secrets.CF_PURGE }}" \
          -H "Content-Type: application/json" \
          --data '{"purge_everything":true}'